name: Test and Publish Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Chrome and ChromeDriver
        shell: pwsh
        run: |
          # Get latest Chrome for Testing version
          Write-Host "Getting latest Chrome for Testing version..."
          $VersionsJson = Invoke-RestMethod "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json"
          $StableVersion = $VersionsJson.channels.Stable.version
          Write-Host "Latest stable Chrome version: $StableVersion"
          
          # Download Chrome for Testing
          Write-Host "Downloading Chrome for Testing..."
          $ChromeZip = "$env:TEMP\chrome-win64.zip"
          $ChromeUrl = "https://storage.googleapis.com/chrome-for-testing-public/$StableVersion/win64/chrome-win64.zip"
          Invoke-WebRequest -Uri $ChromeUrl -OutFile $ChromeZip
          
          # Extract Chrome
          $ChromePath = "C:\chrome-win64"
          Write-Host "Extracting Chrome to $ChromePath..."
          Expand-Archive $ChromeZip -DestinationPath "C:\" -Force
          Remove-Item $ChromeZip
          
          # Add Chrome to PATH
          $env:PATH = "$ChromePath;" + $env:PATH
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")
          
          # Download matching ChromeDriver
          Write-Host "Downloading ChromeDriver..."
          $DriverZip = "$env:TEMP\chromedriver-win64.zip"
          $DriverUrl = "https://storage.googleapis.com/chrome-for-testing-public/$StableVersion/win64/chromedriver-win64.zip"
          Invoke-WebRequest -Uri $DriverUrl -OutFile $DriverZip
          
          # Extract ChromeDriver
          $ChromeDriverPath = "C:\ChromeDriver"
          Write-Host "Extracting ChromeDriver to $ChromeDriverPath..."
          New-Item -ItemType Directory -Force -Path $ChromeDriverPath
          Expand-Archive $DriverZip -DestinationPath "C:\" -Force
          Copy-Item "C:\chromedriver-win64\chromedriver.exe" $ChromeDriverPath -Force
          Remove-Item $DriverZip
          Remove-Item "C:\chromedriver-win64" -Recurse -Force
          
          # Add ChromeDriver to PATH
          $env:PATH = "$ChromeDriverPath;" + $env:PATH
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")
          
          Write-Host "Chrome and ChromeDriver installation completed"
          Write-Host "Chrome version:"
          & "$ChromePath\chrome.exe" --version
          Write-Host "ChromeDriver version:"
          & "$ChromeDriverPath\chromedriver.exe" --version
          
      - name: Setup .NET Framework
        shell: pwsh
        run: |
          # Download .NET Framework 4.8 Developer Pack
          $url = "https://go.microsoft.com/fwlink/?linkid=2088517"
          $outFile = "ndp48-devpack-enu.exe"
          
          Write-Host "Downloading .NET Framework 4.8 Developer Pack..."
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $webClient = New-Object System.Net.WebClient
          $webClient.DownloadFile($url, $outFile)
          
          Write-Host "Installing .NET Framework 4.8 Developer Pack..."
          Start-Process -FilePath $outFile -ArgumentList "/quiet", "/norestart" -Wait -NoNewWindow
          
          Write-Host ".NET Framework 4.8 Developer Pack installation completed"
          
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1
          
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2.0
        
      - name: Setup VSTest
        uses: darenm/Setup-VSTest@v1
        
      - name: Restore NuGet packages
        run: nuget restore CSTestFramework.sln
        
      - name: Build Solution
        run: |
          msbuild CSTestFramework.sln /p:Configuration=Debug /p:Platform="Any CPU" /p:RestorePackages=true /verbosity:detailed
        
      - name: Install Allure CommandLine
        shell: pwsh
        run: |
          Write-Host "Installing Allure..."
          
          # Download and extract Allure
          $allureVersion = "2.24.1"
          $allureUrl = "https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/$allureVersion/allure-commandline-$allureVersion.zip"
          $allureZip = "allure.zip"
          $allureDir = "allure-$allureVersion"
          
          # Create a directory for Allure
          New-Item -ItemType Directory -Force -Path "C:\allure"
          Set-Location "C:\allure"
          
          # Download and extract
          Write-Host "Downloading Allure from $allureUrl"
          Invoke-WebRequest -Uri $allureUrl -OutFile $allureZip
          Expand-Archive -Path $allureZip -DestinationPath . -Force
          
          # Add to PATH
          $allureBinPath = "C:\allure\$allureDir\bin"
          Write-Host "Adding $allureBinPath to PATH"
          $env:PATH = "$allureBinPath;" + $env:PATH
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")
          
          # Verify installation
          Write-Host "Allure installation directory contents:"
          Get-ChildItem -Path $allureBinPath
          
          # Return to original directory
          Set-Location $env:GITHUB_WORKSPACE
          
          Write-Host "Allure installation completed"
        
      - name: Run Tests
        shell: pwsh
        run: |
          $env:ALLURE_RESULTS_DIRECTORY="$pwd\allure-results"
          New-Item -ItemType Directory -Force -Path "allure-results"
          
          Write-Host "Test DLLs search path: .\**\bin\Debug"
          $testDlls = Get-ChildItem -Recurse -Filter "*Tests.dll" -Path ".\**\bin\Debug" | Where-Object { $_.FullName -match 'bin\\Debug' }
          
          Write-Host "Found test DLLs:"
          $testDlls | ForEach-Object { Write-Host $_.FullName }
          
          foreach ($dll in $testDlls) {
              Write-Host "Running tests in: $($dll.FullName)"
              vstest.console.exe $dll.FullName /Logger:"trx;LogFileName=$pwd\TestResults.trx" /TestAdapterPath:packages
          }
        
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults.trx
          
      - name: Generate Allure Report
        if: always()
        shell: pwsh
        run: |
          Write-Host "Current directory: $pwd"
          Write-Host "Current PATH: $env:PATH"
          
          Write-Host "Checking allure-results directory:"
          Get-ChildItem "allure-results" -Recurse
          
          Write-Host "Checking Allure installation:"
          Get-Command allure -ErrorAction SilentlyContinue
          
          Write-Host "Generating Allure report..."
          & "C:\allure\allure-2.24.1\bin\allure.bat" generate allure-results -o allure-report --clean
          
          Write-Host "Checking generated report:"
          Get-ChildItem "allure-report" -Recurse
        
      - name: Setup Pages
        if: success()
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        if: success()
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'allure-report'
          
      - name: Deploy to GitHub Pages
        if: success()
        id: deployment
        uses: actions/deploy-pages@v4 