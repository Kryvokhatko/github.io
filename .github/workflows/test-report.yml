name: Test and Publish Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET Framework
        run: |
          choco install dotnet-framework-4.8-devpack -y
          choco install dotnet-framework-4.8 -y
          
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1
          
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2.0
        
      - name: Setup VSTest
        uses: darenm/Setup-VSTest@v1
        
      - name: Restore NuGet packages
        run: nuget restore CSTestFramework.sln
        
      - name: Build Solution
        run: |
          msbuild CSTestFramework.sln /p:Configuration=Debug /p:Platform="Any CPU" /p:RestorePackages=true /verbosity:detailed
        
      - name: Install Allure CommandLine
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          choco install allure -y
        shell: pwsh
        
      - name: Run Tests
        run: |
          $env:ALLURE_RESULTS_DIRECTORY="$pwd\allure-results"
          New-Item -ItemType Directory -Force -Path "allure-results"
          
          # Find all test DLLs
          $testDlls = Get-ChildItem -Recurse -Filter "*Tests.dll" -Path ".\**\bin\Debug" | Where-Object { $_.FullName -match 'bin\\Debug' }
          
          foreach ($dll in $testDlls) {
              Write-Host "Running tests in: $($dll.FullName)"
              vstest.console.exe $dll.FullName /Logger:"trx;LogFileName=$pwd\TestResults.trx" /TestAdapterPath:packages
          }
        shell: pwsh
        
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: TestResults.trx
        
      - name: Generate Allure Report
        if: always()
        run: |
          Write-Host "Current directory: $pwd"
          Write-Host "Checking allure-results directory:"
          Get-ChildItem "allure-results" -Recurse
          
          allure generate allure-results -o allure-report --clean
          
          Write-Host "Checking generated report:"
          Get-ChildItem "allure-report" -Recurse
        shell: pwsh
        
      - name: Setup Pages
        if: success()
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        if: success()
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'allure-report'
          
      - name: Deploy to GitHub Pages
        if: success()
        id: deployment
        uses: actions/deploy-pages@v4 