name: Test Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'
      
      - name: List directory contents
        run: |
          dir
          dir .github\workflows
      
      - name: Restore NuGet packages
        run: |
          nuget restore CSTestFramework.sln
          dotnet restore CSTestFramework.sln --force
      
      - name: Build
        run: dotnet build CSTestFramework.sln --configuration Release
      
      - name: Setup Java for Allure
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Allure CommandLine
        run: |
          Invoke-WebRequest -Uri "https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.zip" -OutFile "allure.zip"
          Expand-Archive -Path "allure.zip" -DestinationPath "."
          $env:PATH += ";$(Get-Location)\allure-2.24.0\bin"
          echo "$env:PATH" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      
      - name: Prepare Allure Results Directory
        run: |
          # Create a clean directory for Allure results
          if (Test-Path "allure-results") { 
            Remove-Item -Recurse -Force "allure-results" -ErrorAction SilentlyContinue
          }
          New-Item -ItemType Directory -Path "allure-results" -Force
      
      # Run API tests with separate process
      - name: Run API Tests
        run: |
          dotnet test API.Tests/CSTestFramework.API.Tests.csproj --configuration Release --no-build --logger "console;verbosity=detailed"
        continue-on-error: true
      
      # Wait a moment before running UI tests to ensure resources are released
      - name: Wait before UI tests
        run: Start-Sleep -Seconds 5
      
      # Run UI tests with separate process
      - name: Run UI Tests
        run: |
          dotnet test UI.Tests/CSTestFramework.UI.Tests.csproj --configuration Release --no-build --logger "console;verbosity=detailed"
        continue-on-error: true
      
      # Collect all Allure results
      - name: Collect Allure Results
        run: |
          # Get NUnit version from packages
          $nunitVersion = (Get-ChildItem -Path "packages" -Recurse -Filter "NUnit*" | Where-Object { $_.PSIsContainer } | Select-Object -First 1).Name
          if (-not $nunitVersion) {
            $nunitVersion = "NUnit (version unknown)"
          }
          Write-Host "Found NUnit version: $nunitVersion"
          
          # Try to get Chrome version
          $chromeVersionInfo = "unknown"
          try {
            $chromeExePath = Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\chrome.exe' -ErrorAction SilentlyContinue | Select-Object -ExpandProperty '(Default)' -ErrorAction SilentlyContinue
            if ($chromeExePath) {
              $version = (Get-Item $chromeExePath -ErrorAction SilentlyContinue).VersionInfo.ProductVersion
              if ($version) { 
                $chromeVersionInfo = $version 
                Write-Host "Found Chrome version: $chromeVersionInfo"
              }
            }
          } catch {
            Write-Host "Error detecting Chrome version: $_"
          }
          
          # Create executor.json
          $executor = @{
            name = "GitHub Actions"
            type = "github"
            reportName = "CSTestFramework Automation Report"
            buildName = "Build #${{ github.run_number }}"
            buildUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            reportUrl = "https://kryvokhatko.github.io/github.io/"
          } | ConvertTo-Json
          
          Set-Content -Path "allure-results/executor.json" -Value $executor -Encoding UTF8
          
          # Copy any test results to the allure-results directory
          Get-ChildItem -Path "API.Tests" -Recurse -Filter "allure-results" | 
            ForEach-Object {
              Copy-Item -Path "$($_.FullName)\*" -Destination "allure-results\" -Recurse -Force -ErrorAction SilentlyContinue
            }
            
          Get-ChildItem -Path "UI.Tests" -Recurse -Filter "allure-results" | 
            ForEach-Object {
              Copy-Item -Path "$($_.FullName)\*" -Destination "allure-results\" -Recurse -Force -ErrorAction SilentlyContinue
            }
          
          # Create environment.properties file AFTER copying test results to ensure it's not overwritten
          $envProps = @(
            "Browser=Chrome",
            "Browser.Version=$chromeVersionInfo",
            "Operating.System=$([System.Environment]::OSVersion.ToString())",
            "Framework=$nunitVersion",
            "Language=C#",
            "Base.URL=https://demo.litecart.net/"
          ) -join "`n"
          
          Write-Host "Writing environment properties:"
          Write-Host $envProps
          
          Set-Content -Path "allure-results/environment.properties" -Value $envProps -Encoding UTF8
          
          # Also create environment.xml for compatibility
          $osVersion = [System.Environment]::OSVersion.ToString()
          
          # Create XML content line by line to avoid YAML parsing issues
          $xmlLines = @()
          $xmlLines += '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>'
          $xmlLines += '<environment>'
          $xmlLines += '    <parameter>'
          $xmlLines += '        <key>Browser</key>'
          $xmlLines += '        <value>Chrome</value>'
          $xmlLines += '    </parameter>'
          $xmlLines += '    <parameter>'
          $xmlLines += '        <key>Browser.Version</key>'
          $xmlLines += "        <value>$chromeVersionInfo</value>"
          $xmlLines += '    </parameter>'
          $xmlLines += '    <parameter>'
          $xmlLines += '        <key>Operating.System</key>'
          $xmlLines += "        <value>$osVersion</value>"
          $xmlLines += '    </parameter>'
          $xmlLines += '    <parameter>'
          $xmlLines += '        <key>Framework</key>'
          $xmlLines += "        <value>$nunitVersion</value>"
          $xmlLines += '    </parameter>'
          $xmlLines += '    <parameter>'
          $xmlLines += '        <key>Language</key>'
          $xmlLines += '        <value>C#</value>'
          $xmlLines += '    </parameter>'
          $xmlLines += '    <parameter>'
          $xmlLines += '        <key>Base.URL</key>'
          $xmlLines += '        <value>https://demo.litecart.net/</value>'
          $xmlLines += '    </parameter>'
          $xmlLines += '</environment>'
          
          $xmlContent = $xmlLines -join "`n"
          Set-Content -Path "allure-results/environment.xml" -Value $xmlContent -Encoding UTF8
          Write-Host "Created environment.xml file"
          
          # Create categories.json for test result categorization
          $categoriesArray = @(
            @{
              name = "Ignored tests"
              matchedStatuses = @("skipped")
            },
            @{
              name = "Infrastructure problems"
              matchedStatuses = @("broken", "failed")
              messageRegex = ".*System\\..*Exception.*"
            },
            @{
              name = "Element interaction failures"
              matchedStatuses = @("broken")
              messageRegex = ".*Element.*not.*found.*"
            },
            @{
              name = "Product defects"
              matchedStatuses = @("failed")
            },
            @{
              name = "Test defects"
              matchedStatuses = @("broken")
            }
          )
          
          $categoriesJson = ConvertTo-Json -InputObject $categoriesArray -Depth 3
          Set-Content -Path "allure-results/categories.json" -Value $categoriesJson -Encoding UTF8
          Write-Host "Created categories.json file"
            
          # Verify environment.properties exists in the results directory
          if (Test-Path "allure-results/environment.properties") {
            Write-Host "environment.properties file exists in allure-results directory"
            Get-Content "allure-results/environment.properties"
          } else {
            Write-Host "WARNING: environment.properties file not found in allure-results directory"
          }
      
      - name: Generate Allure Report
        run: |
          allure generate allure-results --clean -o allure-report
          
          # Ensure environment.xml is in the data directory
          if (Test-Path "allure-results/environment.xml") {
            Write-Host "Copying environment.xml to report data directory"
            if (-not (Test-Path "allure-report/data")) {
              New-Item -ItemType Directory -Path "allure-report/data" -Force
            }
            Copy-Item -Path "allure-results/environment.xml" -Destination "allure-report/data/" -Force
          }
          
          # Verify environment.properties in the generated report
          if (Test-Path "allure-report/data/environment.xml") {
            Write-Host "environment.xml file exists in allure-report/data directory"
            Get-Content "allure-report/data/environment.xml"
          } else {
            Write-Host "WARNING: environment.xml file not found in allure-report/data directory"
          }
      
      - name: Upload Allure Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Allure Report
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: allure-report

      # Try to download history from the gh-pages branch if it exists
      - name: Try to get history from gh-pages branch
        id: get_history
        continue-on-error: true
        run: |
          mkdir -p allure-history
          git fetch origin gh-pages --depth=1 || echo "No gh-pages branch found"
          if git rev-parse --verify origin/gh-pages >/dev/null 2>&1; then
            echo "Found gh-pages branch, checking for history"
            git checkout origin/gh-pages -- history || echo "No history directory in gh-pages branch"
            if [ -d "history" ]; then
              echo "History directory found, copying to allure-history"
              cp -r history allure-history/ || true
              echo "history_found=true" >> $GITHUB_OUTPUT
            else
              echo "No history directory found in gh-pages branch"
              echo "history_found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No gh-pages branch found"
            echo "history_found=false" >> $GITHUB_OUTPUT
          fi

      # Prepare history directory
      - name: Prepare Allure history
        run: |
          mkdir -p allure-report/history
          if [ -d "allure-history/history" ] && [ "$(ls -A allure-history/history 2>/dev/null)" ]; then
            echo "Previous history found, copying to report"
            cp -r allure-history/history/* allure-report/history/ || true
          else
            echo "No previous history found, using empty history directory"
          fi

      - name: Verify Allure Report Directory
        run: |
          # Check if the directory exists and has content
          if [ -d "allure-report" ]; then
            echo "Allure report directory exists"
            find allure-report -type f | wc -l
          else
            echo "Allure report directory does not exist"
            exit 1
          fi
      
      # Direct HTML modification to remove subtitle
      - name: Direct HTML modification
        run: |
          if [ -f "allure-report/index.html" ]; then
            echo "Performing direct HTML modification to remove subtitle"
            
            # Create a temporary file to hold the modified HTML
            cat allure-report/index.html > temp.html
            
            # Use awk to process the HTML file and remove the subtitle div
            awk '
            {
              # Skip printing lines containing the subtitle
              if (index($0, "side-nav__brand-subtitle") > 0) {
                next;
              }
              # Print all other lines
              print;
            }' temp.html > allure-report/index.html
            
            # Clean up
            rm temp.html
            
            # Replace the entire brand section with a custom one
            sed -i 's|<div class="side-nav__brand">.*<div class="side-nav__brand-text">.*</div>.*</div>|<div class="side-nav__brand"><div class="side-nav__brand-text">CSTESTFRAMEWORK AUTOMATION REPORT</div></div>|g' allure-report/index.html
            
            echo "Direct HTML modification completed"
          fi
      
      # Ensure executor.json is properly set
      - name: Update executor information
        run: |
          # First, let's examine the structure to understand what files need to be modified
          echo "Examining Allure report structure..."
          find allure-report -type f -name "*.js" -o -name "*.json" -o -name "*.html" | xargs grep -l "unknown" || true
          
          # Create a complete report-data.json file
          mkdir -p allure-report/data
          cat > allure-report/data/report-data.json << EOF
          {
            "uid" : "$(date +%s%N)",
            "name" : "CSTestFramework Automation Report",
            "children" : [ ],
            "befores" : [ ],
            "afters" : [ ],
            "links" : [ ],
            "start" : $(date +%s%N | cut -b1-13),
            "stop" : $(date +%s%N | cut -b1-13),
            "reportName" : "CSTestFramework Automation Report",
            "projectName": "CSTestFramework",
            "reportVersion": "1.0"
          }
          EOF
          
          # Create a custom plugin to override the subtitle
          mkdir -p allure-report/plugins/custom-subtitle-fix
          cat > allure-report/plugins/custom-subtitle-fix/index.js << EOF
          (function() {
            var oldGetReportName = window.allure.getReportName;
            window.allure.getReportName = function() {
              return "CSTestFramework Automation Report";
            };
            
            // Override the subtitle getter if it exists
            if (window.allure.getReportSubtitle) {
              window.allure.getReportSubtitle = function() {
                return "";
              };
            }
            
            // Add CSS to hide subtitle
            var style = document.createElement('style');
            style.type = 'text/css';
            style.innerHTML = '.side-nav__brand-subtitle { display: none !important; }';
            document.getElementsByTagName('head')[0].appendChild(style);
          })();
          EOF
          
          # Add the custom plugin to the index.html
          if [ -f "allure-report/index.html" ]; then
            echo "Adding custom plugin to index.html"
            sed -i 's|</body>|<script src="plugins/custom-subtitle-fix/index.js"></script>\n</body>|' allure-report/index.html
            
            # Also add a script to the head that will run before Allure loads
            echo "Adding early script to override subtitle"
            sed -i 's|<head>|<head>\n<script>\nwindow.allureSubtitleOverride = true;\nObject.defineProperty(window, "allure", {\n  get: function() { return this._allure; },\n  set: function(val) {\n    if (val && typeof val === "object") {\n      if (val.getReportSubtitle) {\n        val.getReportSubtitle = function() { return ""; };\n      }\n    }\n    this._allure = val;\n  }\n});\n</script>|' allure-report/index.html
          fi
          
          # More aggressive approach to fix the title in index.html
          if [ -f "allure-report/index.html" ]; then
            echo "Fixing title in index.html"
            # Replace the title line completely
            sed -i 's|<title>Allure Report</title>|<title>CSTestFramework Automation Report</title>|g' allure-report/index.html
            # Try to find and replace the unknown subtitle
            sed -i 's|unknown - unknown (Unknown)||g' allure-report/index.html
            # Another possible format
            sed -i 's|UNKNOWN - UNKNOWN (UNKNOWN)||g' allure-report/index.html
            
            # Try to directly modify the HTML structure to remove the subtitle element
            echo "Attempting to modify HTML structure to remove subtitle..."
            
            # Remove the subtitle div if it exists
            sed -i 's|<div class="side-nav__brand-subtitle">.*</div>||g' allure-report/index.html
            
            # Create a custom CSS to hide the subtitle
            echo "<style>.side-nav__brand-subtitle { display: none !important; }</style>" >> allure-report/index.html
          fi
          
          # Fix app.js which likely contains the subtitle logic
          if [ -f "allure-report/app.js" ]; then
            echo "Fixing app.js"
            # Try to find and replace various patterns that might be causing the issue
            sed -i 's|reportName+".*unknown.*"|reportName+""|g' allure-report/app.js || true
            sed -i 's|reportName+" - "+.*unknown.*|reportName+""|g' allure-report/app.js || true
            sed -i 's|unknown - unknown (Unknown)||g' allure-report/app.js || true
            
            # Add project information directly
            echo "
            window.allure = window.allure || {};
            window.allure.project = {
              name: 'CSTestFramework',
              version: '1.0'
            };
            // Override the title rendering function if it exists
            if (window.allure.getReportName) {
              window.allure.getReportName = function() {
                return 'CSTestFramework Automation Report';
              };
            }
            " >> allure-report/app.js
          fi
          
          # Fix bundle.js which might contain the subtitle logic
          if [ -f "allure-report/plugins/screen-diff/styles.css" ]; then
            echo "Adding custom CSS to hide subtitle"
            echo ".side-nav__brand-subtitle { display: none !important; }" >> allure-report/plugins/screen-diff/styles.css
          fi
          
          if [ -f "allure-report/bundle.js" ]; then
            echo "Fixing bundle.js"
            # Try to find and replace various patterns that might be causing the issue
            sed -i 's|unknown - unknown (Unknown)||g' allure-report/bundle.js || true
            sed -i 's|"unknown"|""|g' allure-report/bundle.js || true
            sed -i 's|subtitle:"unknown"|subtitle:""|g' allure-report/bundle.js || true
            sed -i 's|subtitle:"unknown (Unknown)"|subtitle:""|g' allure-report/bundle.js || true
          fi
          
          # Create a custom CSS file to hide the subtitle
          echo "Creating custom CSS to hide subtitle"
          mkdir -p allure-report/styles
          cat > allure-report/styles/custom.css << EOF
          .side-nav__brand-subtitle {
            display: none !important;
          }
          EOF
          
          # Add the custom CSS to the index.html
          if [ -f "allure-report/index.html" ]; then
            echo "Adding custom CSS to index.html"
            sed -i 's|</head>|<link rel="stylesheet" href="styles/custom.css">\n</head>|' allure-report/index.html
          fi
          
          # Create widgets files
          mkdir -p allure-report/widgets
          cat > allure-report/widgets/summary.json << EOF
          {
            "reportName": "CSTestFramework Automation Report",
            "testRuns": [],
            "statistic": {
              "failed": 0,
              "broken": 0,
              "skipped": 0,
              "passed": 0,
              "unknown": 0,
              "total": 0
            },
            "time": {}
          }
          EOF
          
          cat > allure-report/widgets/executors.json << EOF
          {
            "total" : 1,
            "items" : [ {
              "name" : "GitHub Actions",
              "type" : "github",
              "url" : "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "buildOrder" : ${{ github.run_number }},
              "buildName" : "Build #${{ github.run_number }}",
              "reportName" : "CSTestFramework Automation Report",
              "reportUrl" : "https://kryvokhatko.github.io/github.io/"
            } ]
          }
          EOF
          
          # Also create executor.json in the root directory
          cat > allure-report/executor.json << EOF
          {
            "name" : "GitHub Actions",
            "type" : "github",
            "reportName" : "CSTestFramework Automation Report",
            "buildName" : "Build #${{ github.run_number }}",
            "buildUrl" : "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "reportUrl" : "https://kryvokhatko.github.io/github.io/"
          }
          EOF
          
          # Create behaviors.json with project information
          cat > allure-report/widgets/behaviors.json << EOF
          {
            "total" : 0,
            "items" : [ ],
            "projectName": "CSTestFramework",
            "projectVersion": "1.0"
          }
          EOF
          
          # Create project-metadata.json
          cat > allure-report/data/project-metadata.json << EOF
          {
            "name": "CSTestFramework",
            "version": "1.0",
            "description": "C# Test Automation Framework",
            "language": "C#",
            "framework": "NUnit"
          }
          EOF
          
          echo "Updated executor information"
      
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: allure-report
          branch: gh-pages
          clean: true
          single-commit: true
          commit-message: "Deploy Allure report from GitHub Actions build ${{ github.run_number }}"
          force: true
      
      # Save history for next run
      - name: Save Allure history
        uses: actions/upload-artifact@v4
        with:
          name: allure-history
          path: allure-report/history
          retention-days: 30 